name: Deploy to EC2 (Docker)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Write SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem

      - name: Check if port 22 is reachable
        run: |
          echo "Host: ${{ secrets.EC2_HOST }}"
          timeout 8 bash -lc "cat < /dev/null > /dev/tcp/${{ secrets.EC2_HOST }}/22" \
         
      - name: SSH test
        run: |
          ssh -vvv -o StrictHostKeyChecking=no -o ConnectTimeout=15 \
            -i ~/.ssh/ec2_key.pem \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" "echo SSH_OK"
